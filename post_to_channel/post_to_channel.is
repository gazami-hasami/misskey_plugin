/// @ 0.12.4

### {
  name: 'ãƒãƒ£ãƒ³ãƒãƒ«æŠ•ç¨¿ãƒœã‚¿ãƒ³è¿½åŠ '
  version: '1.1'
  author: '@piga@misskey.io'
  description: 'æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒãƒ£ãƒ³ãƒãƒ«ã¸æŠ•ç¨¿ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚'
  permissions: ["read:channels"]
  config: {
    limit: {
      type: 'number'
      label: 'å–å¾—ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«æ•°ã®ä¸Šé™'
      description: 'ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ãŒå¢—ãˆãŸã‚‰å¤‰æ›´ã—ã¦ã­'
      default: 30
    }
  }
}

var CH_ARR = []

// objã®nullãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å†å¸°çš„ã«é™¤å» https://qiita.com/saki-lere/items/851c4500d56659d15c9c
@remove_null_property(object) {
  if Core:type(object) != 'obj' {
    return object
  }
  let new_obj = {}
  each let kv Obj:kvs(object) {
    let v = remove_null_property(kv[1])
    if Core:type(v) != 'null' {
      Obj:set(new_obj kv[0] v)
    }
  }
  return new_obj
}

// æŠ•ç¨¿å…ˆã‚’idã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸åˆ‡ã‚Šæ›¿ãˆã‚‹
@switch_destination(id) {
  var new_arr = []

  each(let i, CH_ARR) {
    if i.id == id { i.is_post = true }
    else { i.is_post = false }
    new_arr.push(i)
  }
  CH_ARR = new_arr
}

// æŠ•ç¨¿å…ˆã®ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’å–å¾—
@get_destination_id() {
  var r_id = null
  var new_arr = []

  each(let i, CH_ARR) {
    if i.is_post {
      i.is_post = false
      r_id = i.id
    }
    new_arr.push(i)
  }
  CH_ARR = new_arr

  return r_id
}

// ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å–å¾—ã—æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹
let channels = Mk:api('channels/followed' {limit: Plugin:config.limit})
each(let i, channels) {
  let ch = {
    id: i.id
    is_post: false
  }
  CH_ARR.push(ch)

  Plugin:register_post_form_action(`{i.name} ã¸æŠ•ç¨¿`, @(form update) {
    switch_destination(i.id)
    Mk:dialog('' `æŠ•ç¨¿å…ˆã‚’ğŸ“º[{i.name}]ã«å¤‰æ›´ã—ãŸã‚ˆ`)
  })
}
Plugin:register_post_form_action(`ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¸æŠ•ç¨¿`, @(form update) {
  switch_destination('')
  Mk:dialog('' `æŠ•ç¨¿å…ˆã‚’ğŸŒã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«å¤‰æ›´ã—ãŸã‚ˆ`)
})

// æŠ•ç¨¿æ™‚ã«æŠ•ç¨¿å…ˆã®ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’æ›¸ãæ›ãˆã‚‹
// ãƒãƒ£ãƒ³ãƒãƒ«ã®æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€ãƒãƒ£ãƒ³ãƒãƒ«IDã¯æ›¸ãæ›ãˆãªã„
Plugin:register_note_post_interruptor(@(note) {
  if note.channelId == null {
    note.channelId = get_destination_id()
  }
  return remove_null_property(note)
})
